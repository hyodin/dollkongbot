# 채팅봇 프론트엔드 및 백엔드 프록시 설정
# 파일 위치: /etc/httpd/conf.d/chatbot.conf

# HTTP 설정 (80 포트)
<VirtualHost *:80>
    # 서버명 설정 (서브도메인 사용 시)
    # ServerName chatbot.yourcompany.com
    
    # 또는 기존 도메인의 서브경로로 사용하는 경우 아래 주석 해제
    # ServerName yourcompany.com
    
    # 프론트엔드 정적 파일 디렉토리
    DocumentRoot /opt/chatbot/frontend/dist
    
    <Directory /opt/chatbot/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router를 위한 설정 (SPA 라우팅 지원)
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # 백엔드 API 프록시 설정
    ProxyPreserveHost On
    ProxyRequests Off
    
    # CORS 헤더 추가 (필요한 경우)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # /api 경로를 백엔드로 프록시
    ProxyPass /api http://localhost:8088/api
    ProxyPassReverse /api http://localhost:8088/api
    
    # /chat, /auth, /admin 경로도 백엔드로 프록시
    ProxyPass /chat http://localhost:8088/chat
    ProxyPassReverse /chat http://localhost:8088/chat
    
    ProxyPass /auth http://localhost:8088/auth
    ProxyPassReverse /auth http://localhost:8088/auth
    
    ProxyPass /admin http://localhost:8088/admin
    ProxyPassReverse /admin http://localhost:8088/admin
    
    # 헬스체크 엔드포인트 프록시
    ProxyPass /health http://localhost:8088/health
    ProxyPassReverse /health http://localhost:8088/health
    
    # API 문서 프록시 (개발/테스트용)
    ProxyPass /docs http://localhost:8088/docs
    ProxyPassReverse /docs http://localhost:8088/docs
    
    # 로그 설정
    ErrorLog /var/log/httpd/chatbot_error.log
    CustomLog /var/log/httpd/chatbot_access.log combined
    
    # 로그 레벨
    LogLevel warn
</VirtualHost>

# HTTPS 설정 (443 포트) - SSL 인증서가 있는 경우
# SSL 인증서 설정 후 아래 주석 해제
<VirtualHost *:443>
    ServerName chatbot.yourcompany.com
    
    # SSL 인증서 설정
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/your-cert.crt
    SSLCertificateKeyFile /etc/ssl/private/your-key.key
    # SSLCertificateChainFile /etc/ssl/certs/your-chain.crt
    
    # SSL 프로토콜 및 암호화 설정
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    
    # 프론트엔드 정적 파일
    DocumentRoot /opt/chatbot/frontend/dist
    
    <Directory /opt/chatbot/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # 백엔드 API 프록시
    ProxyPreserveHost On
    ProxyPass /api http://localhost:8088/api
    ProxyPassReverse /api http://localhost:8088/api
    ProxyPass /chat http://localhost:8088/chat
    ProxyPassReverse /chat http://localhost:8088/chat
    ProxyPass /auth http://localhost:8088/auth
    ProxyPassReverse /auth http://localhost:8088/auth
    ProxyPass /admin http://localhost:8088/admin
    ProxyPassReverse /admin http://localhost:8088/admin
    ProxyPass /health http://localhost:8088/health
    ProxyPassReverse /health http://localhost:8088/health
    
    ErrorLog /var/log/httpd/chatbot_ssl_error.log
    CustomLog /var/log/httpd/chatbot_ssl_access.log combined
    LogLevel warn
</VirtualHost>

# 기존 Apache 설정과 통합 (서브경로 방식)
# 회사 홈페이지와 같은 도메인에서 /chatbot 경로로 접근하려면:
# 아래 설정을 기존 VirtualHost 블록에 추가하세요

# Alias /chatbot /opt/chatbot/frontend/dist
# 
# <Directory /opt/chatbot/frontend/dist>
#     Options -Indexes +FollowSymLinks
#     AllowOverride All
#     Require all granted
#     
#     RewriteEngine On
#     RewriteBase /chatbot
#     RewriteRule ^chatbot/index\.html$ - [L]
#     RewriteCond %{REQUEST_FILENAME} !-f
#     RewriteCond %{REQUEST_FILENAME} !-d
#     RewriteRule ^chatbot/(.*) /chatbot/index.html [L]
# </Directory>
# 
# ProxyPass /chatbot/api http://localhost:8088/api
# ProxyPassReverse /chatbot/api http://localhost:8088/api

