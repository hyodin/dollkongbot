# 채팅봇 프론트엔드 및 백엔드 프록시 설정 (Nginx)
# 파일 위치: /etc/nginx/conf.d/chatbot.conf

# HTTP 서버 설정 (80 포트)
server {
    listen 80;
    server_name chatbot.yourcompany.com;  # 또는 기존 도메인
    
    # 클라이언트 최대 요청 크기 (파일 업로드용)
    client_max_body_size 10M;
    
    # 프론트엔드 정적 파일 서빙
    root /opt/chatbot/frontend/dist;
    index index.html;
    
    # 로그 설정
    access_log /var/log/nginx/chatbot_access.log;
    error_log /var/log/nginx/chatbot_error.log;
    
    # Gzip 압축 활성화
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # React Router를 위한 설정 (SPA 라우팅 지원)
    # 모든 요청을 index.html로 리다이렉트 (파일이 존재하지 않는 경우)
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 정적 파일 캐싱 설정
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 백엔드 API 프록시
    location /api {
        proxy_pass http://localhost:8088/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 채팅 API 프록시
    location /chat {
        proxy_pass http://localhost:8088/chat;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 인증 API 프록시
    location /auth {
        proxy_pass http://localhost:8088/auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 관리자 API 프록시
    location /admin {
        proxy_pass http://localhost:8088/admin;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 헬스체크 프록시
    location /health {
        proxy_pass http://localhost:8088/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }
    
    # API 문서 프록시 (개발/테스트용)
    location /docs {
        proxy_pass http://localhost:8088/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# HTTPS 서버 설정 (443 포트) - SSL 인증서가 있는 경우
# SSL 인증서 설정 후 아래 주석 해제
server {
    listen 443 ssl http2;
    server_name chatbot.yourcompany.com;
    
    # SSL 인증서 설정
    ssl_certificate /etc/ssl/certs/your-cert.crt;
    ssl_certificate_key /etc/ssl/private/your-key.key;
    # ssl_trusted_certificate /etc/ssl/certs/your-chain.crt;
    
    # SSL 프로토콜 및 암호화 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 클라이언트 최대 요청 크기
    client_max_body_size 10M;
    
    # 프론트엔드 정적 파일 서빙
    root /opt/chatbot/frontend/dist;
    index index.html;
    
    # 로그 설정
    access_log /var/log/nginx/chatbot_ssl_access.log;
    error_log /var/log/nginx/chatbot_ssl_error.log;
    
    # Gzip 압축
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # React Router를 위한 설정
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 정적 파일 캐싱
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 백엔드 API 프록시
    location /api {
        proxy_pass http://localhost:8088/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 채팅 API 프록시
    location /chat {
        proxy_pass http://localhost:8088/chat;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 인증 API 프록시
    location /auth {
        proxy_pass http://localhost:8088/auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 관리자 API 프록시
    location /admin {
        proxy_pass http://localhost:8088/admin;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 헬스체크 프록시
    location /health {
        proxy_pass http://localhost:8088/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }
    
    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}

# 기존 Nginx 설정과 통합 (서브경로 방식)
# 회사 홈페이지와 같은 도메인에서 /chatbot 경로로 접근하려면:
# 아래 설정을 기존 server 블록에 추가하세요

# location /chatbot {
#     alias /opt/chatbot/frontend/dist;
#     index index.html;
#     try_files $uri $uri/ /chatbot/index.html;
# }
# 
# location /chatbot/api {
#     proxy_pass http://localhost:8088/api;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
# }

